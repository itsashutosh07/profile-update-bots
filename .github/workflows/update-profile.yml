name: Update Naukri Profile

on:
  schedule:
    # Runs 6 times per day (scheduled 30 minutes early to account for GitHub Actions delay)
    # Target times: 5 AM, 8:30 AM, 11 AM, 12:30 PM, 3 PM, 5:30 PM IST
    - cron: '0 23 * * *'   # 11:00 PM UTC = 4:30 AM IST (‚Üí ~5:00 AM with delay)
    - cron: '30 2 * * *'   # 2:30 AM UTC = 8:00 AM IST (‚Üí ~8:30 AM with delay)
    - cron: '0 5 * * *'    # 5:00 AM UTC = 10:30 AM IST (‚Üí ~11:00 AM with delay)
    - cron: '30 6 * * *'   # 6:30 AM UTC = 12:00 PM IST (‚Üí ~12:30 PM with delay)
    - cron: '0 9 * * *'    # 9:00 AM UTC = 2:30 PM IST (‚Üí ~3:00 PM with delay)
    - cron: '30 11 * * *'  # 11:30 AM UTC = 5:00 PM IST (‚Üí ~5:30 PM with delay)
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gnupg
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r naukri/requirements.txt
    
    - name: Run update script
      id: update
      continue-on-error: true
      env:
        NAUKRI_EMAIL: ${{ secrets.NAUKRI_EMAIL }}
        NAUKRI_PASSWORD: ${{ secrets.NAUKRI_PASSWORD }}
        GMAIL_CLIENT_ID: ${{ secrets.GMAIL_CLIENT_ID }}
        GMAIL_CLIENT_SECRET: ${{ secrets.GMAIL_CLIENT_SECRET }}
        GMAIL_REFRESH_TOKEN: ${{ secrets.GMAIL_REFRESH_TOKEN }}
        HEADLESS: "true"
      run: |
        echo "=== Starting Naukri Profile Update ==="
        python3 naukri/update.py
        EXIT_CODE=$?
        echo "Script exited with code: $EXIT_CODE"
        exit $EXIT_CODE
    
    - name: Check run status
      id: status_check
      if: always()
      run: |
        echo "=== Run Status Check ==="
        
        # Find the status file
        STATUS_FILE=$(find "Logs Screenshot" -name "run_status.json" -type f | head -n 1)
        
        if [ -f "$STATUS_FILE" ]; then
          echo "Status file found: $STATUS_FILE"
          echo "--- Status Details ---"
          cat "$STATUS_FILE"
          echo "----------------------"
          
          # Extract status
          STATUS=$(cat "$STATUS_FILE" | python3 -c "import sys, json; print(json.load(sys.stdin)['status'])")
          MESSAGE=$(cat "$STATUS_FILE" | python3 -c "import sys, json; print(json.load(sys.stdin)['message'])")
          
          echo "Status: $STATUS"
          echo "Message: $MESSAGE"
          
          # Store status for next step
          echo "BOT_STATUS=$STATUS" >> $GITHUB_ENV
          
          case "$STATUS" in
            "SUCCESS")
              echo "‚úÖ Profile updated successfully"
              ;;
            "RATE_LIMITED")
              echo "üïí Rate limited - will retry on next schedule"
              echo "This is expected behavior, not a failure"
              ;;
            "FAILURE")
              echo "‚ùå Update failed - check logs for details"
              exit 1
              ;;
            *)
              echo "‚ö†Ô∏è Unknown status: $STATUS"
              ;;
          esac
        else
          echo "‚ö†Ô∏è No status file found - check if script completed"
          if [ "${{ steps.update.outcome }}" == "failure" ]; then
            echo "‚ùå Script execution failed"
            exit 1
          fi
        fi
    
    - name: Mark as Rate Limited
      if: always() && env.BOT_STATUS == 'RATE_LIMITED'
      run: |
        echo "üïí This run was rate limited by Naukri.com"
        echo "The dashboard will detect this step to show accurate status"
    
    - name: Upload screenshots as artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots-${{ github.run_number }}
        path: Logs Screenshot/
        retention-days: 7


